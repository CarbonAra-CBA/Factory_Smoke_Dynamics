<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>오염물질 확산 결과</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.2/heatmap.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-heatmap@1.0.0/leaflet-heatmap.min.js"></script>
  <script src="https://unpkg.com/leaflet-geometryutil@0.13.1/leaflet.geometryutil.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 500px;  /* 컨테이너의 최대 너비를 500px로 설정 */
            margin: 0 auto;
            padding: 10px;
        }
        h2 {
            text-align: center;
            color: #333;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        .map-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 500px;  /* 지도 컨테이너의 최대 너비를 500px로 설정 */
            margin: 0 auto 20px;  /* 중앙 정렬을 위해 margin 수정 */
            
            border-radius: 10px;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 300px;
            border-radius: 10px;
            overflow: hidden;
        }
        .arrow-btn {
            background-color: #f0f0f0; /* 전체 화면 배경색과 동일하게 설정 */
            border: none;
            font-size: 24px;
            padding: 10px;
            cursor: pointer;
            z-index: 10;
        }
        .arrow-btn:hover {
            background-color: #e0e0e0; /* 호버 시 약간 어두운 색상 */
        }
        .info-box {
            background-color: #fff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .info-item {
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        .info-label {
            font-weight: bold;
            margin-right: 10px;
        }
        @media (max-width: 500px) {
            .container, .map-container {
                width: 100%;
                max-width: 100%;
            }
        }
        .report-button-container {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            z-index: 1000;
        }
        
        .report-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .report-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>오염물질 확산 결과</h2>
        <div class="map-container">
            <button class="arrow-btn left" onclick="moveMap('left')">&lt;</button>
            <div id="map"></div>
            <button class="arrow-btn right" onclick="moveMap('right')">&gt;</button>
        </div>
        <div class="info-box">
            <div class="info-item">
                <span class="info-label">배출 시기:</span>
                <span id="emission-time"></span>
            </div>
            <div class="info-item">
                <span class="info-label">배출되는 오염물질:</span>
                <span id="pollutant">SO_2</span>
            </div>
            <div class="info-item">
                <span class="info-label">거주지로 확산된 양:</span>
                <span id="amount">42ppm</span>
            </div>
            <div class="info-item">
                <span class="info-label">장기 노출 시 발병 가능한 질환:</span>
                <span id="disease">급성 폐렴</span>
            </div>
        </div>
    </div>
    <div class="report-button-container">
        <button class="report-button" onclick="location.href='progress.html'">보고서 작성</button>
    </div>

    <script src="heatmap_smoke.js"></script>
    <script>
        let factoryList=[{
            factory_name : "성창기업㈜",
            latitude : 35.0506138959485,
            longitude : 128.972068123449,
            SOx : 100,
            PM10 : 50,
            NOx : 0,
            direction : 90,
            speed : 1.7,
            time : "2024-05-01 13:50"
        },
        {
            factory_name : "영철강㈜",
            latitude : 35.0562054900165,
            longitude : 128.959863397159,
            SOx : 0,
            PM10 : 70,
            NOx : 0,
            direction : 350,
            speed : 2.5,
            time : "2024-05-01 14:30"
        }
        ];

        let currentFactoryIndex = 0;
        let startLat = 35.0516482081223;
        let startLng = 128.965077815255;
        let factory = factoryList[currentFactoryIndex];
        let particle_type = determineParticleType(factory);
        let wind = {
            direction : factory.direction,
            speed : factory.speed
        };

        const diseaseMap = new Map([
            ['SOx', '급성 폐렴'],
            ['PM10', '만성 기관지염'],
            ['NOx', '천식']
        ]);

        let heatmapLayers = []; // 각 공장의 히트맵 레이어를 저장할 배열

        function determineParticleType(factory) {
            const particles = ['SOx', 'PM10', 'NOx'];
            return particles.reduce((a, b) => factory[a] > factory[b] ? a : b);
        }

        function updateInfo() {
            document.getElementById('emission-time').textContent = factory.time;
            document.getElementById('pollutant').textContent = particle_type;
            document.getElementById('amount').textContent = factory[particle_type] + 'ppm';
            document.getElementById('disease').textContent = diseaseMap.get(particle_type);
        }

        function moveMap(direction) {
            if (direction === 'right') {
                currentFactoryIndex = (currentFactoryIndex + 1) % factoryList.length;
            } else {
                currentFactoryIndex = (currentFactoryIndex - 1 + factoryList.length) % factoryList.length;
            }
            factory = factoryList[currentFactoryIndex];
            particle_type = determineParticleType(factory);
            wind = {
                direction: factory.direction,
                speed: factory.speed
            };
            updateMap();
        }

        function updateMap() {
            map.setView([factory.latitude, factory.longitude], 14);
            marker.setLatLng([factory.latitude, factory.longitude]);
            popupFactory.setContent("<b>회사명 : " + factory.factory_name + "</b>");
            marker.openPopup();
            updateInfo();

            // 모든 히트맵 레이어를 비활성화
            heatmapLayers.forEach(layer => map.removeLayer(layer));

            // 현재 공장의 히트맵 레이어만 활성화
            map.addLayer(heatmapLayers[currentFactoryIndex]);
        }

        // 맵 초기화
        var map = L.map('map', {
            center: [startLat, startLng],
            zoom: 14,
            zoomControl: false
        });

        // 타일 설정 ( OSM )
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // 각 공장에 대한 히트맵 레이어 생성
        factoryList.forEach((factory, index) => {
            let particleType = determineParticleType(factory);
            let wind = {
                direction: factory.direction,
                speed: factory.speed
            };
            let heatmapLayer = addSmokeHeatmap_single(map, factory, particleType, wind);
            heatmapLayers.push(heatmapLayer);
            
            // 첫 번째 공장의 히트맵 레이어만 초기에 활성화
            if (index === 0) {
                map.addLayer(heatmapLayer);
            }
        });

        // 공장의 굴뚝 위치와 사용자 위치에 마커를 표시하고 팝업 창을 동시에 띄우기
        let marker = L.marker([factory.latitude, factory.longitude]).addTo(map);
        let markerUser = L.marker([startLat, startLng], {icon: L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        })}).addTo(map);

        let popupFactory = L.popup().setContent("<b>회사명 : " + factory.factory_name + "</b>");
        let popupUser = L.popup().setContent("<b>거주지</b>");

        marker.bindPopup(popupFactory);
        markerUser.bindPopup(popupUser);

        // 두 팝업을 동시에 열기
        marker.openPopup();
        markerUser.openPopup();

        // 초기 정보 업데이트
        updateInfo();
    </script>
</body>
</html>